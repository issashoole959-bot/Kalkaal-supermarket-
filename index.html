<!doctype html>
<html lang="so">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalkaal Supermarket System (v1)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background: #f4fbff; }
    .brand { color:#0d6efd; font-weight:700; }
    .low-badge { background:#ffc107; color:#000; padding:3px 7px; border-radius:6px; font-weight:600; }
    .card { box-shadow: 0 1px 4px rgba(13,110,253,0.06); }
    .small-muted { font-size:0.85rem; color:#6c757d; }
    .table-sm td, .table-sm th { vertical-align: middle; }
    .suggestions { position: absolute; z-index:50; background:#fff; width:100%; border:1px solid #ddd; max-height:200px; overflow:auto; }
    .suggest-item { padding:8px; cursor:pointer; }
    .suggest-item:hover { background:#f1f7ff; }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container-fluid">
      <span class="navbar-brand brand">Kalkaal Supermarket System</span>
      <div id="nav-right"></div>
    </div>
  </nav>

  <div class="container py-4" id="app">
    <!-- Login -->
    <div id="loginView" class="row justify-content-center">
      <div class="col-md-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h4 class="mb-3 text-center">Admin Login</h4>
            <form id="loginForm">
              <div class="mb-3">
                <label class="form-label">Username</label>
                <input id="loginUser" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Password</label>
                <input id="loginPass" type="password" class="form-control" required>
              </div>
              <button class="btn btn-primary w-100">GALI</button>
            </form>
            <p class="small-muted mt-2">Username: <b>admin</b> — Password: <b>12345</b></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main views -->
    <div id="mainView" style="display:none;">
      <div class="row g-3">
        <div class="col-md-3">
          <div class="card p-3">
            <h6>Tirakoob</h6>
            <div class="mt-2">
              <div class="mb-2 small-muted">Items guud</div>
              <h4 id="statItems">0</h4>
            </div>
            <div class="mt-2">
              <div class="mb-2 small-muted">Items ku dhow inay dhamaadaan</div>
              <h4 id="statLow">0</h4>
            </div>
            <div class="mt-2">
              <div class="mb-2 small-muted">Iibka maanta</div>
              <h4 id="statToday">0.00</h4>
            </div>
            <div class="mt-3">
              <button class="btn btn-sm btn-outline-secondary w-100 mb-2" onclick="go('items')">Manage Items</button>
              <button class="btn btn-sm btn-success w-100 mb-2" onclick="go('sales')">Iib Cusub</button>
              <button class="btn btn-sm btn-primary w-100" onclick="go('reports')">Reports</button>
            </div>
          </div>
        </div>

        <div class="col-md-9">
          <div id="dashboardView">
            <div class="card p-3 mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <h5>Dashboard</h5>
                <div>
                  <span class="me-3">Admin: <b id="adminName">admin</b></span>
                  <button class="btn btn-outline-secondary btn-sm" id="logoutBtn">Logout</button>
                </div>
              </div>
              <p class="small-muted mt-2">Ku soo dhawow Kalkaal Supermarket System — halkaan ka maamul items, iibka iyo warbixinnada.</p>
            </div>

            <div class="card p-3">
              <h6>Items Ku Dhaw</h6>
              <div id="lowItemsList"></div>
            </div>
          </div>

          <!-- Items view -->
          <div id="itemsView" style="display:none;">
            <div class="card p-3 mb-3 d-flex justify-content-between align-items-center">
              <h5>Maareynta Items</h5>
              <div>
                <button class="btn btn-outline-secondary me-2" onclick="go('dashboard')">Dashboard</button>
                <button class="btn btn-primary" id="showAddItemBtn">Add Item</button>
              </div>
            </div>

            <div class="card p-3 mb-3">
              <form id="addItemForm" class="row g-2">
                <input type="hidden" id="editItemId">
                <div class="col-md-4"><input id="itemName" class="form-control" placeholder="Magaca item" required></div>
                <div class="col-md-2"><input id="itemPrice" class="form-control" placeholder="Qiime (USD)" type="number" step="0.01" required></div>
                <div class="col-md-2"><input id="itemQty" class="form-control" placeholder="Tirada" type="number" required></div>
                <div class="col-md-2"><input id="itemLow" class="form-control" placeholder="Threshold" type="number" value="5" required></div>
                <div class="col-md-2"><button class="btn btn-success w-100" id="saveItemBtn">Ku dar / Update</button></div>
              </form>
            </div>

            <div class="card p-3">
              <h6>Liiska Items</h6>
              <input id="searchItem" class="form-control mb-2" placeholder="Raadi item...">
              <div style="max-height:420px; overflow:auto;">
                <table class="table table-sm">
                  <thead><tr><th>Magac</th><th>Qiime</th><th>Tirada</th><th>Threshold</th><th>Action</th></tr></thead>
                  <tbody id="itemsTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Sales view -->
          <div id="salesView" style="display:none;">
            <div class="card p-3 mb-3 d-flex justify-content-between">
              <h5>Iib Cusub</h5>
              <div>
                <button class="btn btn-outline-secondary" onclick="go('dashboard')">Dashboard</button>
                <button class="btn btn-outline-secondary" onclick="go('items')">Items</button>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-md-6 position-relative">
                <div class="card p-3">
                  <h6>Item-yada</h6>
                  <input id="saleSearch" class="form-control mb-2" placeholder="Raadi item...">
                  <div id="saleSuggest" class="suggestions" style="display:none;"></div>
                  <div id="saleItemsList" style="max-height:300px; overflow:auto;"></div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card p-3">
                  <h6>Cart</h6>
                  <div id="cartArea"><p class="text-muted">Cart waa madhan yahay.</p></div>

                  <div class="mt-3 d-flex gap-2">
                    <select id="paymentType" class="form-select w-auto">
                      <option value="Paid">Paid</option>
                      <option value="Credit">Credit</option>
                    </select>
                    <input id="creditName" class="form-control" placeholder="Magaca macaamiisha (credit)" style="display:none;">
                    <button id="saveSaleBtn" class="btn btn-success ms-auto">Save Iib</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Reports view -->
          <div id="reportsView" style="display:none;">
            <div class="card p-3 mb-3 d-flex justify-content-between">
              <h5>Warbixinno</h5>
              <div>
                <button class="btn btn-outline-secondary" onclick="go('dashboard')">Dashboard</button>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <div class="card p-3">
                  <h6>Iibka Maanta</h6>
                  <h3 id="reportTodayTotal">0.00</h3>
                  <div class="mt-3">
                    <h6>Credit Customers</h6>
                    <ul id="reportCredits" class="list-group"></ul>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card p-3">
                  <h6>Items ku dhow inay dhamaadaan</h6>
                  <ul id="reportLow" class="list-group"></ul>
                </div>
              </div>
            </div>
          </div>

        </div> <!-- /col-md-9 -->
      </div> <!-- /row -->
    </div> <!-- /mainView -->
  </div> <!-- /container -->

<script>
/* ===========================
   Storage helpers & init
   =========================== */
/* Use keys unique to v1 to avoid interfering with v2 */
const KEY_ITEMS = 'kalk_v1_items';
const KEY_SALES = 'kalk_v1_sales';
const KEY_CUSTOMERS = 'kalk_v1_customers';

/* Admin credentials (v1) */
const ADMIN_USER = 'admin';
const ADMIN_PASS = '12345'; // v1 password (hidden in input)

function load(key) { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e) { return []; } }
function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
function uid(prefix='id') { return prefix + '_' + Date.now() + '_' + Math.floor(Math.random()*9000+1000); }

let items = load(KEY_ITEMS);
let sales = load(KEY_SALES);
let customers = load(KEY_CUSTOMERS);

/* If empty first time, seed example items (optional) */
if (!items || items.length === 0) {
  items = [
    { id: uid('it'), name: 'Rice 5kg', price: 10.00, quantity: 10, low:5 },
    { id: uid('it'), name: 'Sugar 2kg', price: 3.50, quantity: 8, low:5 },
    { id: uid('it'), name: 'Bread', price: 0.50, quantity: 20, low:5 }
  ];
  save(KEY_ITEMS, items);
}

/* ================
   Auth & UI helpers
   ================ */
const loginView = document.getElementById('loginView');
const mainView = document.getElementById('mainView');
const navRight = document.getElementById('nav-right');

function showMain() {
  loginView.style.display = 'none';
  mainView.style.display = '';
  navRight.innerHTML = `<div class="d-flex align-items-center"><small class="me-3">Admin: <b>${ADMIN_USER}</b></small></div>`;
  updateStats();
  renderLowList();
  showAlertIfLow();
}

function logout() {
  sessionStorage.removeItem('kalk_v1_logged');
  location.reload();
}

/* Login form */
document.getElementById('loginForm').addEventListener('submit', function(e){
  e.preventDefault();
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if (u === ADMIN_USER && p === ADMIN_PASS) {
    sessionStorage.setItem('kalk_v1_logged','1');
    showMain();
    Swal.fire('Sax','Waan ku soo dhaweynayaa','success');
  } else {
    Swal.fire('Khalad','Username ama password khalad ah','error');
  }
});

/* Auto-login if session */
if (sessionStorage.getItem('kalk_v1_logged')) {
  document.getElementById('adminName').innerText = ADMIN_USER;
  showMain();
}

/* Logout btn */
document.getElementById('logoutBtn').addEventListener('click', logout);

/* ================
   Navigation
   ================ */
function hideAllViews() {
  document.getElementById('dashboardView').style.display = 'none';
  document.getElementById('itemsView').style.display = 'none';
  document.getElementById('salesView').style.display = 'none';
  document.getElementById('reportsView').style.display = 'none';
}
function go(page) {
  hideAllViews();
  if (page === 'dashboard') document.getElementById('dashboardView').style.display = '';
  if (page === 'items') { document.getElementById('itemsView').style.display = ''; renderItemsTable(); }
  if (page === 'sales') { document.getElementById('salesView').style.display = ''; renderSaleItemsList(); }
  if (page === 'reports') { document.getElementById('reportsView').style.display = ''; renderReports(); }
}

/* ================
   Items CRUD
   ================ */
const itemsTable = document.getElementById('itemsTable');
const addItemForm = document.getElementById('addItemForm');

function renderItemsTable(filter='') {
  items = load(KEY_ITEMS);
  itemsTable.innerHTML = '';
  const q = filter.trim().toLowerCase();
  items.forEach(it => {
    if (q && !it.name.toLowerCase().includes(q)) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(it.name)}</td>
      <td>${parseFloat(it.price).toFixed(2)}</td>
      <td>${parseInt(it.quantity)} ${it.quantity <= it.low ? `<span class="ms-2 low-badge">Low</span>` : ''}</td>
      <td>${parseInt(it.low)}</td>
      <td>
        <button class="btn btn-sm btn-secondary me-1" data-act="edit" data-id="${it.id}">Edit</button>
        <button class="btn btn-sm btn-danger" data-act="del" data-id="${it.id}">Delete</button>
      </td>`;
    itemsTable.appendChild(tr);
  });
}

function escapeHtml(s) { return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

itemsTable.addEventListener('click', function(e){
  const btn = e.target.closest('button');
  if (!btn) return;
  const act = btn.dataset.act;
  const id = btn.dataset.id;
  if (act === 'edit') {
    const it = items.find(x=>x.id===id);
    if (!it) return;
    document.getElementById('editItemId').value = it.id;
    document.getElementById('itemName').value = it.name;
    document.getElementById('itemPrice').value = parseFloat(it.price);
    document.getElementById('itemQty').value = parseInt(it.quantity);
    document.getElementById('itemLow').value = parseInt(it.low);
    window.scrollTo({top:0, behavior:'smooth'});
  } else if (act === 'del') {
    Swal.fire({ title:'Ma hubtaa?', text:'Miyaad rabtaa inaad tirtirto itemkan?', icon:'warning', showCancelButton:true })
    .then(res=>{ if (res.isConfirmed) {
      items = items.filter(x=>x.id !== id); save(KEY_ITEMS, items); renderItemsTable(document.getElementById('searchItem').value || ''); updateStats(); Swal.fire('La tirtiray','Item waa la tirtiray','success');
    }});
  }
});

/* Add/Edit */
addItemForm.addEventListener('submit', function(e){
  e.preventDefault();
  const id = document.getElementById('editItemId').value;
  const name = document.getElementById('itemName').value.trim();
  const price = parseFloat(document.getElementById('itemPrice').value) || 0;
  const qty = parseInt(document.getElementById('itemQty').value) || 0;
  const low = parseInt(document.getElementById('itemLow').value) || 5;
  if (!name) return Swal.fire('Khalad','Fadlan geli magaca item','error');
  items = load(KEY_ITEMS);
  if (id) {
    items = items.map(it => it.id === id ? {...it, name, price, quantity: qty, low } : it);
    Swal.fire('La cusbooneysiiyey','Item waa la cusbooneysiiyey','success');
  } else {
    items.push({ id: uid('it'), name, price, quantity: qty, low });
    Swal.fire('La daray','Item cusub waa la daray','success');
  }
  save(KEY_ITEMS, items);
  document.getElementById('editItemId').value = ''; addItemForm.reset(); renderItemsTable(); updateStats();
});

/* Search */
document.getElementById('searchItem').addEventListener('input', function(){ renderItemsTable(this.value); });
document.getElementById('showAddItemBtn').addEventListener('click', function(){ document.getElementById('editItemId').value = ''; addItemForm.reset(); window.scrollTo({top:0, behavior:'smooth'}); });

/* ================
   Sales (cart) + Autocomplete
   ================ */
let cart = [];
const saleSearch = document.getElementById('saleSearch');
const saleSuggest = document.getElementById('saleSuggest');

function renderSaleItemsList() {
  items = load(KEY_ITEMS);
  const container = document.getElementById('saleItemsList');
  container.innerHTML = '';
  items.forEach(it => {
    const div = document.createElement('div');
    div.className = 'd-flex align-items-center justify-content-between p-2 border-bottom';
    div.innerHTML = `
      <div>
        <strong>${escapeHtml(it.name)}</strong><br>
        <small>${parseFloat(it.price).toFixed(2)} USD — Qty: ${it.quantity}</small>
        ${it.quantity <= it.low ? ` <span class="low-badge ms-2">Low</span>` : ''}
      </div>
      <div style="min-width:140px">
        <input type="number" value="1" min="1" max="${it.quantity}" class="form-control form-control-sm mb-1 addQty" data-id="${it.id}">
        <button class="btn btn-sm btn-primary w-100 addToCart" data-id="${it.id}">Add</button>
      </div>`;
    container.appendChild(div);
  });
  saleSearch.value = '';
  hideSuggest();
}

document.getElementById('saleItemsList').addEventListener('click', function(e){
  const btn = e.target.closest('button.addToCart'); if (!btn) return;
  const id = btn.dataset.id; const qtyInput = btn.parentElement.querySelector('.addQty'); let q = parseInt(qtyInput.value) || 1;
  const it = items.find(x=>x.id===id); if (!it) return Swal.fire('Error','Item lama helin','error'); if (q > it.quantity) return Swal.fire('Error',`Kaliya ${it.quantity} ayaa la heli karaa`,`error`);
  addToCart(id,q);
});

saleSearch.addEventListener('input', function(){
  const q = this.value.trim().toLowerCase();
  if (!q) { renderSaleItemsList(); hideSuggest(); return; }
  items = load(KEY_ITEMS);
  const matches = items.filter(it => it.name.toLowerCase().includes(q));
  if (matches.length === 0) { hideSuggest(); renderSaleItemsList(); return; }
  saleSuggest.innerHTML = '';
  matches.forEach(m => {
    const d = document.createElement('div');
    d.className = 'suggest-item';
    d.innerHTML = `<strong>${escapeHtml(m.name)}</strong> — ${parseFloat(m.price).toFixed(2)} USD — Qty: ${m.quantity}`;
    d.dataset.id = m.id;
    d.addEventListener('click', function(){ addToCart(this.dataset.id, 1); hideSuggest(); saleSearch.value = ''; });
    saleSuggest.appendChild(d);
  });
  saleSuggest.style.display = 'block';
});
function hideSuggest(){ saleSuggest.style.display = 'none'; saleSuggest.innerHTML = ''; }

function addToCart(id,q=1) {
  const it = items.find(x=>x.id===id); if (!it) return;
  const found = cart.find(x=>x.id===id); if (found){ found.qty += q; if (found.qty > it.quantity) found.qty = it.quantity; } else cart.push({ id: it.id, name: it.name, price: it.price, qty: q });
  renderCart();
}

function renderCart(){
  const area = document.getElementById('cartArea');
  if (cart.length === 0) { area.innerHTML = '<p class="text-muted">Cart waa madhan yahay.</p>'; return; }
  let html = `<table class="table table-sm"><thead><tr><th>Item</th><th>Qty</th><th>Unit</th><th>Subtotal</th><th></th></tr></thead><tbody>`;
  let total = 0;
  cart.forEach((c, idx) => { const sub = c.qty * parseFloat(c.price); total += sub;
    html += `<tr><td>${escapeHtml(c.name)}</td><td><input type="number" min="1" value="${c.qty}" class="form-control form-control-sm cartQty" data-i="${idx}" style="width:90px"></td><td>${parseFloat(c.price).toFixed(2)}</td><td>${sub.toFixed(2)}</td><td><button class="btn btn-sm btn-danger removeLine" data-i="${idx}">x</button></td></tr>`; });
  html += `</tbody></table><div class="text-end"><h5>Total: <span id="cartTotal">${total.toFixed(2)}</span> USD</h5></div>`;
  area.innerHTML = html;
}

document.getElementById('cartArea').addEventListener('click', function(e){
  const btn = e.target.closest('button.removeLine'); if (btn){ const i = parseInt(btn.dataset.i); cart.splice(i,1); renderCart(); return; }
});
document.getElementById('cartArea').addEventListener('change', function(e){
  const inp = e.target.closest('input.cartQty'); if (!inp) return; const i = parseInt(inp.dataset.i); let v = parseInt(inp.value) || 1; const it = items.find(x=>x.id === cart[i].id);
  if (v > it.quantity) { Swal.fire('Error','Qty exceeds available stock','error'); inp.value = cart[i].qty; return; } cart[i].qty = v; renderCart();
});

document.getElementById('paymentType').addEventListener('change', function(){ document.getElementById('creditName').style.display = this.value === 'Credit' ? '' : 'none'; });

document.getElementById('saveSaleBtn').addEventListener('click', function(){
  if (cart.length === 0) return Swal.fire('Error','Cart waa madhan','error');
  const payment = document.getElementById('paymentType').value;
  const custName = document.getElementById('creditName').value.trim();
  if (payment === 'Credit' && !custName) return Swal.fire('Error','Fadlan gali magaca macaamiisha (credit)','error');

  items = load(KEY_ITEMS);
  try { cart.forEach(c => { const it = items.find(x=>x.id===c.id); if (!it) throw new Error(`Item ${c.name} lama helin`); if (c.qty > it.quantity) throw new Error(`Item '${it.name}' kaliya ${it.quantity} ayaa la heli karaa, codsatay ${c.qty}`); }); }
  catch(err) { return Swal.fire('Error', err.message, 'error'); }

  let total = 0; cart.forEach(c => total += c.qty * parseFloat(c.price)); total = parseFloat(total.toFixed(2));
  const sale = { id: uid('s'), total, payment, customer: payment==='Credit' ? custName : null, date: new Date().toISOString(), lines: cart.map(c=>({...c})) };
  sales = load(KEY_SALES); sales.push(sale); save(KEY_SALES, sales);

  items = items.map(it => { const line = cart.find(l => l.id === it.id); if (line) return {...it, quantity: it.quantity - line.qty}; return it; });
  save(KEY_ITEMS, items);

  if (payment === 'Credit') { customers = load(KEY_CUSTOMERS); let c = customers.find(x => x.name.toLowerCase() === custName.toLowerCase()); if (c) c.balance = parseFloat((parseFloat(c.balance) + total).toFixed(2)); else { c = { id: uid('c'), name: custName, balance: total }; customers.push(c); } save(KEY_CUSTOMERS, customers); }

  cart = []; renderCart(); renderSaleItemsList(); renderItemsTable(); updateStats(); showAlertIfLow(); Swal.fire('Saved','Iibka waa la keydiyey','success');
});

/* ================
   Reports & stats + Pay (with admin pass)
   ================ */
function updateStats(){
  items = load(KEY_ITEMS); sales = load(KEY_SALES); customers = load(KEY_CUSTOMERS);
  document.getElementById('statItems').innerText = items.length;
  const lowCount = items.filter(i => i.quantity <= i.low).length; document.getElementById('statLow').innerText = lowCount;
  const today = new Date().toISOString().slice(0,10);
  const todayTotal = (sales.filter(s => s.date.slice(0,10) === today).reduce((a,b)=> a + parseFloat(b.total), 0) || 0).toFixed(2);
  document.getElementById('statToday').innerText = todayTotal;
}

function renderLowList(){ const lowList = items.filter(i => i.quantity <= i.low); const container = document.getElementById('lowItemsList'); if (lowList.length === 0) container.innerHTML = '<p class="text-muted">Items wanaagsan — ma jiraan wax ku dhow inay dhamaadaan.</p>'; else { let html = '<ul class="list-group">'; lowList.forEach(i => html += `<li class="list-group-item d-flex justify-content-between">${escapeHtml(i.name)} <span class="text-danger">${i.quantity}</span></li>`); html += '</ul>'; container.innerHTML = html; } }

function showAlertIfLow() { const low = items.filter(i => i.quantity <= i.low); if (low.length > 0) { const names = low.map(i => `${i.name} (${i.quantity})`).join(', '); Swal.fire({ icon:'warning', title:'Stock Alert', html:`Items ku dhow inay dhammaan: <br><b>${names}</b>`, timer:8000 }); } }

function renderReports(){
  sales = load(KEY_SALES); customers = load(KEY_CUSTOMERS); items = load(KEY_ITEMS);
  const today = new Date().toISOString().slice(0,10);
  const todayTotal = (sales.filter(s=>s.date.slice(0,10)===today).reduce((a,b)=> a + parseFloat(b.total), 0) || 0).toFixed(2);
  document.getElementById('reportTodayTotal').innerText = todayTotal;
  const rc = document.getElementById('reportCredits'); rc.innerHTML = '';
  if (customers.length === 0) rc.innerHTML = '<li class="list-group-item text-muted'>Ma jiraan credit customers</li>';
  else customers.forEach(c => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<div>${escapeHtml(c.name)} <br><small class="text-muted">Balance: ${parseFloat(c.balance).toFixed(2)} USD</small></div><div><button class="btn btn-sm btn-success me-2 payBtn" data-id="${c.id}">Pay</button></div>`;
    rc.appendChild(li);
  });

  const rl = document.getElementById('reportLow'); rl.innerHTML = '';
  const lowList = items.filter(i => i.quantity <= i.low);
  if (lowList.length === 0) rl.innerHTML = '<li class="list-group-item text-muted">Ma jiraan items ku dhow inay dhamaadaan</li>';
  else lowList.forEach(i => rl.innerHTML += `<li class="list-group-item d-flex justify-content-between">${escapeHtml(i.name)} <span>${i.quantity}</span></li>`);
}

/* Pay flow */
document.getElementById('reportCredits').addEventListener('click', function(e){
  const btn = e.target.closest('button.payBtn');
  if (!btn) return;
  const cid = btn.dataset.id; customers = load(KEY_CUSTOMERS); const cust = customers.find(x=>x.id === cid);
  if (!cust) return Swal.fire('Error','Customer lama helin','error');

  Swal.fire({
    title: `Bixin deynta: ${cust.name}`,
    html: `<input id="sw-amount" type="number" class="swal2-input" placeholder="Lacag (USD)" min="0.01" step="0.01"><input id="sw-pass" type="password" class="swal2-input" placeholder="Geli password admin">`,
    showCancelButton: true,
    confirmButtonText: 'Bixi',
    preConfirm: () => {
      const amount = parseFloat(document.getElementById('sw-amount').value);
      const pass = document.getElementById('sw-pass').value;
      if (!amount || amount <= 0) { Swal.showValidationMessage('Fadlan geli lacag sax ah'); return false; }
      if (amount > parseFloat(cust.balance)) { Swal.showValidationMessage('Lacagta way ka badan tahay balance-ka'); return false; }
      if (!pass) { Swal.showValidationMessage('Fadlan geli password'); return false; }
      if (pass !== ADMIN_PASS) { Swal.showValidationMessage('Password khalad ah'); return false; }
      return { amount, pass };
    }
  }).then(result => {
    if (result.isConfirmed && result.value) {
      const { amount } = result.value;
      customers = load(KEY_CUSTOMERS);
      const cc = customers.find(x=>x.id === cid);
      cc.balance = parseFloat((parseFloat(cc.balance) - amount).toFixed(2));
      if (cc.balance < 0.005) cc.balance = 0;
      save(KEY_CUSTOMERS, customers);
      sales = load(KEY_SALES); sales.push({ id: uid('p'), type:'Payment', customer: cc.name, amount: amount, date: new Date().toISOString() }); save(KEY_SALES, sales);
      renderReports(); updateStats(); Swal.fire('La bixiyey','Lacagta waa la xaqiijiyey','success');
    }
  });
});

/* initial render */
renderItemsTable(); renderSaleItemsList(); updateStats();
if (sessionStorage.getItem('kalk_v1_logged')) { go('dashboard'); } else { hideAllViews(); }
</script>
</body>
</html>
